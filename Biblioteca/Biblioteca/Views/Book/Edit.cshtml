@model Biblioteca.ViewModels.BookAuthorViewModel
@{
    ViewBag.Title = "Edit";
}

<h2>Edit</h2>
@section Scripts{
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.10.0.min.js" type="text/javascript"></script>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.9.2/jquery-ui.min.js" type="text/javascript"></script>
<link href="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.9.2/themes/blitzer/jquery-ui.css"
      rel="Stylesheet" type="text/css" />
    <script type="text/javascript">
        $(document).ready(function () {
            var lastIndex = parseInt($("input.index:last").val());
            $("#btnPlus").click(function () {
              
              //alert(lastIndex);
              var element = $(".dummy").clone();
              element.removeClass("dummy");
              element.find(".authorSelect").attr("name", "authors["+lastIndex+"]");
              element.find(".index").val(lastIndex + 1);
              
             
              lastIndex = lastIndex + 1;
              
              element.insertBefore("tr.after");
            })
            $(document).on("click", ".btnMinus", function () {
                 $(this).parent().parent().remove();
              
                //$("#authorTable").remove(element);
            });
            var author = null;
            $(document).on("click", ".authorSelect", function () {
                $(".authorSelect").autocomplete({
                    source: function (request, response) {
                        $.ajax({
                            url: '@Url.Action("AutoComplete", "Book", null, Request.Url.Scheme)',
                            data: "{ 'prefix': '" + request.term + "'}",
                            dataType: "json",
                            type: "POST",
                            contentType: "application/json; charset=utf-8",
                            success: function (data) {
                                response($.map(data, function (item) {
                                    author = item.author;
                                    return item;
                                }))
                               
                            },
                            error: function (response) {
                                alert(response.responseText);
                            },
                            failure: function (response) {
                                alert(response.responseText);
                            }
                        });
                    },
                    select: function (e, i) {
                        $(".authorId").val(i.item.val);
                    },
                    minLength: 1
                });
            });            
        })
    </script>
    <style>
    .dummy
    {
         display:none;
         visibility:hidden;
    }
        
    </style>
 }


<div id="main">
    @using (Html.BeginForm(FormMethod.Post))
    {
        @Html.ValidationSummary(true)
        <fieldset>
            <legend>Book</legend>
            @Html.HiddenFor(model => model.Book.id)

            @Html.HiddenFor(model => model.Book.shelf_id)
            <div class="editor-label">
                <label>Title</label>
            </div>
            <div class="editor-field">
                @Html.TextBoxFor(model => model.Book.name)
                @Html.ValidationMessageFor(model => model.Book.name)
            </div>

            <div class="editor-label">
                @Html.LabelFor(model => model.Book.ISBN)
            </div>
            <div class="editor-field">
                @Html.TextBoxFor(model => model.Book.ISBN)
                @Html.ValidationMessageFor(model => model.Book.ISBN)
            </div>

            <div class="editor-label">
                <label>Release Date</label>
            </div>
            <div class="editor-field">
                @Html.TextBoxFor(model => model.Book.release_date)
                @Html.ValidationMessageFor(model => model.Book.release_date)
            </div>
            <div class="editor-label">
                <label>On Loan Qty</label>
            </div>
            <div class="editor-field">
                @Html.TextBoxFor(model => model.Book.on_loan)
                @Html.ValidationMessageFor(model => model.Book.on_loan)
            </div>
            <div class="editor-label">
                <label>Nr Copies</label>
            </div>
            <div class="editor-field">
                @Html.TextBoxFor(model => model.Book.nr_copies)
                @Html.ValidationMessageFor(model => model.Book.nr_copies)
            </div>

            <hr />
            <div>
                <label>Authors</label>
            </div>
            <table id="authorTable">
                <tr>
                    <th><label>First Name</label></th>
                    <th><label>Last Name</label></th>
                </tr>
                <tr class="dummy">
                    <td class="first_name"><input type="text" class="authorSelect" /></td>
                   
                    <!--<td class="last_name"><input type="text" class="ln" /></td>--> 
                    <td><input class="btnMinus" type="button" value="-" /></td>
                    <td><input type="hidden" name="id" class="authorId" /></td>
                    <td><input type="hidden" class="bookId" value="@Model.Book.id" /></td>
                    <td><input type="hidden" class="index" /></td>
                </tr>
                    @for (int i = 0; i < Model.Authors.Count(); i++)
                    {
                        <tr>
                            <td>@Html.TextBoxFor(model => Model.Authors[i].first_name)</td>
                            <td>@Html.TextBoxFor(model => Model.Authors[i].last_name)</td>
                            <td><input class="btnMinus" type="button" value="-" /></td>
                            <td><input type="hidden" class="authorId" value="@Model.Authors[i].id" /></td>
                            <td><input type="hidden" class="bookId" value="@Model.Book.id" /></td>
                            <td><input type="hidden" class="index" value="@i" /></td>
                        </tr>
                }
              <tr class="after"></tr>
            </table>
            <table>
                <tr>

                    <td>
                        <!--<input type="text" name="first_name" class="authorSelect" />-->
                        
                        @*<input type="hidden" name="id" class="authorId"/>*@
                        <br /><br />
                    </td>
                    <td>
                        <input type="button" id="btnPlus" value="+"/>
                    </td>
                </tr>
            </table>
            <hr />
            <p>
                <input type="submit" value="Save" class="authSubmit" />
                
            </p>


        </fieldset>
    }
</div>
<div>
    
    @Html.ActionLink("Back to List", "Index")
</div>



